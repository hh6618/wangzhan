<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ç®€å•ç½‘ç«™</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="search-container">
      <input type="text" id="postSearchInput" placeholder="æœç´¢å¸–å­åç§°...">
  </div>

  <div class="category-filter-container">
      <label for="categoryFilter">æŒ‰åˆ†ç±»ç­›é€‰:</label>
      <select id="categoryFilter">
          <option value="">æ‰€æœ‰åˆ†ç±»</option>
          <option value="å…¬å‘Š">å…¬å‘Š</option>
          <option value="è®¨è®º">è®¨è®º</option>
          <option value="åˆ†äº«">åˆ†äº«</option>
          <option value="é—®ç­”">é—®ç­”</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
  </div>


  <h1>æ¬¢è¿æ¥åˆ°æˆ‘çš„ç½‘ç«™ï¼</h1>
  <p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„HTMLé¡µé¢ã€‚</p>

  <div class="convention-section">
      <h2>ç½‘ç«™å…¬çº¦</h2>
      <p>ä¸ºäº†æ›´å¥½åœ°çŸ¥é“æ˜¯è°å†™çš„å¸–å­æˆ–è¯„è®ºï¼Œè¯·åœ¨æœ€åä¸€æ®µè¯é‡ŒåŠ ä¸Šä½ çš„ç½‘åï¼ˆå¯ä»¥ç®€å†™ï¼‰ã€‚ä½†æ˜¯å¿…å¡«å“Ÿã€‚
        æç¤ºï¼šæ‰‹æœºç”¨æˆ·å¯ä»¥é€šè¿‡å¦‚æœè§‰å¾—ç½‘é¡µå¸ƒå±€è¿‡äºæ‹¥æŒ¤å¯åŒæŒ‡æœå†…æ»‘åŠ¨å¼ºåˆ¶ç¼©æ”¾ç½‘ç«™
      </p>
  </div>

  <div class="post-section">
      <h2>å‘å¸ƒæ–°æ–‡ç« /å…¬å‘Š</h2>
      <form id="postForm">
          <input type="text" id="authorNicknameInput" placeholder="ä½ çš„ç½‘å (å¯é€‰)">
          <input type="text" id="postTitle" placeholder="æ–‡ç« æ ‡é¢˜" required>
          <textarea id="postContent" placeholder="æ–‡ç« å†…å®¹" required></textarea>
          <label for="postCategory">é€‰æ‹©åˆ†ç±»:</label>
          <select id="postCategory" required>
              <option value="">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»</option>
              <option value="å…¬å‘Š">å…¬å‘Š</option>
              <option value="è®¨è®º">è®¨è®º</option>
              <option value="åˆ†äº«">åˆ†äº«</option>
              <option value="é—®ç­”">é—®ç­”</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
          <button type="submit">å‘å¸ƒ</button>
      </form>
  </div>

  <div class="posts-display">
      <h2>æœ€æ–°æ–‡ç« /å…¬å‘Š</h2>
      <div id="postsContainer">
          </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Supabase åˆå§‹åŒ–
        const SUPABASE_URL = 'https://ucztckxladpgbzjvcwck.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjenRja3hsYWRwZ2J6anZjd2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTkxNTcsImV4cCI6MjA2ODQ5NTE1N30.kLa03Hgd33_roU_B3-wSVKwjeaJLxwddu4_v_Y05RBw';

        if (typeof supabase === 'undefined') {
            console.error("Supabase library not loaded. Please check the CDN link.");
            alert("Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œ CDN é“¾æ¥ã€‚");
            return;
        }

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const postForm = document.getElementById('postForm');
        const postsContainer = document.getElementById('postsContainer');
        const postSearchInput = document.getElementById('postSearchInput');
        const postCategorySelect = document.getElementById('postCategory');
        const categoryFilterSelect = document.getElementById('categoryFilter');
        const authorNicknameInput = document.getElementById('authorNicknameInput');

        // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“å•ä¸ªå¸–å­ï¼ˆä¸ºäº†å®æ—¶æ›´æ–°å’Œç‚¹èµåŠŸèƒ½é‡ç”¨ï¼‰
        async function renderPost(p) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.innerHTML = `
                <h3>${p.title}</h3>
                <p>${p.content}</p>
                <small>ä½œè€…: ${p.author_nickname || 'åŒ¿å'} | åˆ†ç±»: ${p.category || 'æœªåˆ†ç±»'} | å‘å¸ƒäº: ${new Date(p.created_at).toLocaleString()}</small>
                <div class="post-actions">
                    <button class="like-button" data-post-id="${p.id}">
                        ğŸ‘ (<span class="like-count">${p.likes_count || 0}</span>)
                    </button>
                    </div>
                <div class="comments-section" id="comments-for-post-${p.id}">
                    <h4>è¯„è®º:</h4>
                    <div class="comments-list"></div>
                    <form class="comment-form" data-post-id="${p.id}">
                        <input type="text" placeholder="ä½ çš„è¯„è®º..." class="comment-input" required>
                        <button type="submit">è¯„è®º</button>
                    </form>
                </div>
            `;
            return postDiv;
        }

        // è¾…åŠ©å‡½æ•°ï¼šåŠ è½½è¯„è®º
        async function loadComments(postId) {
            const { data: comments, error: commentsError } = await supabaseClient
                .from('comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: true });

            if (commentsError) {
                console.error("Error loading comments for post", postId, commentsError);
                return [];
            }
            return comments;
        }

        // å¤„ç†ç‚¹èµæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        async function handleLikeButtonClick(e) {
            const button = e.currentTarget;
            const postId = button.dataset.postId;
            const likeCountSpan = button.querySelector('.like-count');
            let currentLikes = parseInt(likeCountSpan.textContent);

            // é€’å¢æœ¬åœ°è®¡æ•°å™¨
            currentLikes++;
            likeCountSpan.textContent = currentLikes;

            // æ›´æ–° Supabase ä¸­çš„ç‚¹èµæ•°
            const { error } = await supabaseClient
                .from('posts')
                .update({ likes_count: currentLikes })
                .eq('id', postId);

            if (error) {
                console.error("Error updating like count:", error);
                // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘å›æ»šæœ¬åœ°è®¡æ•°å™¨æˆ–æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                alert('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
                likeCountSpan.textContent = currentLikes - 1; // å›æ»šæ˜¾ç¤º
            }
        }

        // ç»‘å®šè¯„è®ºè¡¨å•å’Œç‚¹èµæŒ‰é’®çš„äº‹ä»¶
        function bindPostInteractionEvents() {
            // ç»‘å®šè¯„è®ºè¡¨å•æäº¤äº‹ä»¶
            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = e.target.dataset.postId;
                    const commentInput = e.target.querySelector('.comment-input');
                    const commentText = commentInput.value;

                    const { error: commentError } = await supabaseClient
                        .from('comments')
                        .insert({ post_id: postId, comment_text: commentText });

                    if (commentError) {
                        alert('å‘å¸ƒè¯„è®ºå¤±è´¥ï¼š' + commentError.message);
                        console.error("Error posting comment:", commentError);
                        return;
                    }

                    commentInput.value = '';
                    loadPosts(postSearchInput.value, categoryFilterSelect.value); // ä¿æŒæœç´¢å’Œåˆ†ç±»çŠ¶æ€åˆ·æ–°
                });
            });

            // ç»‘å®šç‚¹èµæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.like-button').forEach(button => {
                // ç¡®ä¿äº‹ä»¶åªç»‘å®šä¸€æ¬¡ï¼Œé¿å…é‡å¤ç»‘å®šå¯¼è‡´å¤šæ¬¡è§¦å‘
                if (!button.dataset.listenerBound) {
                    button.addEventListener('click', handleLikeButtonClick);
                    button.dataset.listenerBound = 'true'; // æ ‡è®°å·²ç»‘å®š
                }
            });
        }


        // 2. é¡µé¢åŠ è½½æ—¶è¯»å–æ–‡ç« å’Œè¯„è®º
        async function loadPosts(searchTerm = '', selectedCategory = '') {
            console.log("Attempting to load posts with search term:", searchTerm, "and category:", selectedCategory);
            let query = supabaseClient
                .from('posts')
                .select('*')
                .order('created_at', { ascending: false });

            if (searchTerm) {
                query = query.ilike('title', `%${searchTerm}%`);
            }

            if (selectedCategory) {
                query = query.eq('category', selectedCategory);
            }

            const { data: posts, error: postsError } = await query;

            if (postsError) {
                postsContainer.innerHTML = '<p>åŠ è½½æ–‡ç« å¤±è´¥ï¼š' + postsError.message + '</p>';
                console.error("Error loading posts:", postsError);
                return;
            }
            postsContainer.innerHTML = '';

            if (posts.length === 0 && (searchTerm || selectedCategory)) {
                let message = 'æœªæ‰¾åˆ°';
                if (searchTerm) message += `åŒ…å« "${searchTerm}" çš„`;
                if (selectedCategory) message += `åˆ†ç±»ä¸º "${selectedCategory}" çš„`;
                message += 'å¸–å­ã€‚';
                postsContainer.innerHTML = `<p>${message}</p>`;
            } else if (posts.length === 0) {
                 postsContainer.innerHTML = '<p>ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•å¸–å­ã€‚</p>';
            }


            for (const p of posts) {
                const postDiv = await renderPost(p);
                postsContainer.appendChild(postDiv);

                const commentsListDiv = postDiv.querySelector('.comments-list');
                const comments = await loadComments(p.id);
                if (comments.length === 0) {
                    commentsListDiv.innerHTML = '<p>æš‚æ— è¯„è®ºã€‚</p>';
                } else {
                    comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment-item';
                        commentDiv.innerHTML = `
                            <p>${comment.comment_text}</p>
                            <small>${new Date(comment.created_at).toLocaleString()}</small>
                        `;
                        commentsListDiv.appendChild(commentDiv);
                    });
                }
            }
            bindPostInteractionEvents(); // æ¯æ¬¡åŠ è½½å¸–å­åç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
        }

        // 3. å‘å¸ƒæ–‡ç« 
        postForm.addEventListener('submit', async e => {
            e.preventDefault();
            const authorNickname = authorNicknameInput.value.trim();
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = postCategorySelect.value;

            if (!category) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼');
                return;
            }

            console.log("Attempting to post article with author:", authorNickname, "category:", category);
            const { error } = await supabaseClient.from('posts').insert({
                title,
                content,
                category,
                author_nickname: authorNickname || 'åŒ¿åç”¨æˆ·',
                likes_count: 0 // æ–°å‘å¸ƒçš„å¸–å­ç‚¹èµæ•°é»˜è®¤ä¸º0
            });
            if (error) {
                alert('å‘å¸ƒæ–‡ç« å¤±è´¥ï¼š' + error.message);
                console.error("Error posting article:", error);
                return;
            }
            postForm.reset();
            postCategorySelect.value = '';
            authorNicknameInput.value = '';
            // å®æ—¶è®¢é˜…ä¼šå¤„ç†é¡µé¢æ›´æ–°
        });

        // 4. æœç´¢åŠŸèƒ½ï¼šç›‘å¬æœç´¢æ¡†è¾“å…¥
        postSearchInput.addEventListener('input', () => {
            loadPosts(postSearchInput.value, categoryFilterSelect.value);
        });

        // 5. åˆ†ç±»ç­›é€‰åŠŸèƒ½ï¼šç›‘å¬åˆ†ç±»é€‰æ‹©æ¡†å˜åŒ–
        categoryFilterSelect.addEventListener('change', () => {
            loadPosts(postSearchInput.value, categoryFilterSelect.value);
        });


        // 6. å®æ—¶æ›´æ–°ï¼šè®¢é˜… posts è¡¨çš„ INSERT äº‹ä»¶
        const postsChannel = supabaseClient.channel('posts_changes');
        postsChannel
            .on(
                'postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'posts' },
                async (payload) => {
                    console.log('New post received in real-time!', payload.new);
                    const newPostData = payload.new;

                    const currentSearchTerm = postSearchInput.value.toLowerCase();
                    const currentCategory = categoryFilterSelect.value;

                    const matchesSearch = !currentSearchTerm || newPostData.title.toLowerCase().includes(currentSearchTerm);
                    const matchesCategory = !currentCategory || newPostData.category === currentCategory;

                    if (matchesSearch && matchesCategory) {
                        const newPostDiv = await renderPost(newPostData);
                        postsContainer.prepend(newPostDiv);
                        bindPostInteractionEvents(); // ä¸ºæ–°æ·»åŠ çš„å¸–å­çš„äº¤äº’ï¼ˆç‚¹èµå’Œè¯„è®ºï¼‰ç»‘å®šäº‹ä»¶
                    }
                }
            )
            .subscribe();

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œï¼ˆé¦–æ¬¡åŠ è½½ï¼‰
        loadPosts();
    });
  </script>
</body>
</html>